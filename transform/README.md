# /transform

크롤링된 게시글 포멧 통일화, 감정 분석, 키워드 추출 등 데이터 변환

formatter를 제외한 모든 코드는 [/emr](https://github.com/softeerbootcamp4th/Team4-monitordog-DE/tree/main/emr) 에서 사용됩니다.

## /trasnform/formatter
각 커뮤니티의 게시판은 구성이 비슷해 보이지만, 담고있는 내용은 조금씩 다릅니다. 디시인사이드의 경우, 오늘 올라온 글에는 작성 시각만 표시되며 이미지를 나타내는 위젯이 따로 텍스트로 표시됩니다. 네이버 카페의 경우, 추천수나 조회수가 4자리를 넘어가면 '1.2천', '4.3만'과 같은 표기를 사용합니다. 이렇게 서로 다른 포멧과 타입으로 들어오는 데이터를 한곳에서 집계하기 위해서는 이들을 하나의 형태로 통일해야 합니다. 
formatter는 이렇게 다른 데이터 형식을 하나로 통일하는 Lambda 함수 입니다. 크롤러를 통해 수집된 게시글 정보가 S3 버킷에 저장되면 트리거에 의해 formatter 함수가 실행됩니다. formatter 함수는 방금 들어온 게시글 데이터의 커뮤니티를 인식하고 커뮤니티별로 처리해 모든 항목의 모든 값이 동일한 형식과 타입을 가지도록 합니다. 또한 다음 단계에서 진행될 감정 분석과 키워드 추출을 위해 본문과 제목에 전처리를 수행합니다.

## issue_score.py
커뮤니티가 특정 주제에 얼마나 관심이 있는지를 쉽게 아는 방법으로는 게시글의 조회수, 추천수, 댓글수가 있습니다. 커뮤니티 유저들은 올라온 게시글에 대해 관심이 있다면 글을 보고, 그에 대해 반응을 게시글 추천과 댓글을 통해 나타냅니다. 만약 유저들이 어떤 주제에 주목하는지 알고자 한다면 주회수나 추천수, 댓글수가 많은 게시글이 어떤 내용인지 보면 알 수 있습니다.
MonitorDog는 특정 키워드에 대한 관심도를 '이슈화 점수'라는 지표로 나타냅니다. 주어진 키워드에 대한 이틀간의 게시글을 모아 이들의 조회수, 추천수, 댓글수를 종합해 이른 하나의 점수로 나타냅니다. 이를 한시간마다 추적하며 유저들이 특정 키워드에 대한 관심이 어떻게 변화해가는지 그래프를 통해 알 수 있습니다.
또한 현재 키워드의 이슈화 추이와 과갸 이슈에 대한 추이를 비교해 가장 비슷한 과거 사례를 제공합니다. DTW(Dynamic Time Warping)를 통해 과거 사건과의 이슈화 추이의 유사도를 계산하고 가장 비슷한 사례를 보여줌으로서 현재 키워드가 앞으로 관심이 어떻게 변하게 될지에 대한 인사이트를 제공합니다.

## keyword_extraction.py
커뮤니티는 매우 다양한 주제로 게시글이 빠르게 모여옵니다. 그러한 곳에서 모든 글을 하나하나 읽으며 내욥을 파악하기에는 시간과 수고가 많이 듭니다. 이러한 작업에 편의를 주고자 MonitorDog는 커뮤니티에 올라온 최신글의 키워드를 추출하고 이를 word cloud 형태로 제공합니다. 이를 통해 현재 커뮤니티에서 어떤 주제로 글이 많이 올라오는지 쉽게 알 수 있습니다.

커뮤니티에서 키워드를 뽑아내기 위해서는 먼저 게시글을 토큰화 해야 합니다. 여기서 MonitorDog는 [바른 형태소 분석기](https://bareun.ai/)를 사용합니다. 바른 형태소 분석기를 사용하는 이유는 다음과 같습니다.
- 토큰화 모델은 최대한 형태소를 정확히 구분해야 합니다. 바른 형태소 분석기는 형태소 구분을 99.6%, 어절 구분을 99.7% 정확도로 수행한다고 주장합니다. 
- 커뮤니티에서 작성된 글은 대체로 구어체 입니다. 바른 형태소 분석기는 '감사합니당'와 같은 구어체 문장에서도 '감사 + 하- + -ᆸ니당'처럼 형태소를 정확하게 구분합니다.
- 줄임말이나 신조어가 빈번하게 사용되고 생성됩니다. 이러한 환경에서 토큰화 모델은 처음 보는 단어에도 언어 모델이 이해할 수 있도록 적절한 토큰을 제공해야 합니다. 바른 형태소 분석기는 모델이 학습하지 않은 단어라도 의미가 최대한 비슷한 토큰을 제공하는 방식으로 대응합니다.

키워드 추출 알고리즘은 함께 사용되는 모델이 바른 형태소 분석기와 함께 사용할 수 있는지를 중점으로 두고 찾아보았습니다. 그 결과 [KPF-KeyBERT](https://github.com/KPF-bigkinds/BIGKINDS-LAB/tree/main/KPF-KeyBERT)를 참고해 작성되었습니다.
키워드 추출은 다음과 같은 과정을 거칩니다.

![](https://user-images.githubusercontent.com/87846939/221451753-58285dc6-2fbc-47bd-9e7a-b90d3879929a.png)
출처: [KPF-KeyBERT 리포지토리](https://github.com/KPF-bigkinds/BIGKINDS-LAB/tree/main/KPF-KeyBERT)

1. 바른 형태소 분석기를 통해 게시글에서 명사만을 추출합니다.
2. 게시글과 추출된 명사를 각각 [kpfSBERT](https://github.com/KPFBERT/kpfSBERT?tab=readme-ov-file)를 통해 임베딩 벡터로 변환합니다.
3. 명사들 중 게시글 벡터와 코사인 유사도가 가장 높은 단어를 첫번째 키워드로 선정합니다.
4. 이후 이미 추출한 키워드와의 코사인 유사도와 게시글와의 코사인 유사도를 바탕으로 다음 키워드를 계속 뽑아냅니다.

다만, 위의 방법대로 키워드를 추출할 시 반드시 정해진 개수의 키워드가 나온다고 보장할 수 없습니다.
- 게시글이 짧은 경우 형태소 분석기가 명사 추출에 실패할 수 있습니다.
  - '아우디 vs 도요타'에서 명사 추출에 실패한 경우가 존재
- 의미가 비슷한 명사들만 모였다면, 키워드가 하나만 나올 가능성도 있습니다.
  - 기존에 뽑힌 키워드와 의미가 덜 유사한 단어를 뽑으려고 한다

## sentiment_analysis.py
MonitorDog는 차량 모델에 대한 부정적인 반응이 생기는지를 알려주기 위해 해당 키워드에 대한 커뮤니티의 분노 정도를 점수로 환산해 제공합니다. 게시글을 수집하는 커뮤니티 특성상, 그리고 자동차에 대한 이슈가 자신의 이미지 혹은 안전과 직결되기에 커뮤니티의 부정적인 반응으로 과격 혹은 혐모 발언이 등장합니다. 이를 이용해 게시글에서 과격한 표현이나 혐오 표현이 포함되어있는지를 감지하고 이를 수치로 보여줍니다.
부정적 혹은 혐오 표현을 감지하기 위해 분류 모델로 [smilegate-ai/kor_unsmile](https://github.com/smilegate-ai/korean_unsmile_dataset)을 사용하였습니다. smilegate ai에서 한국어 혐오 표현 데이터셋과 함께, 이를 학습한 분류 모델도 제공하고 있습니다. 학습한 데이터셋은 구어체에서 발생하는 혐오 표현을 감지하기에 커뮤니티 게시글에 사용하기 적합했습니다.
unsmile 모델을 통해 게시글이 clean(혐오표현 없음)에 포함될 확률을 구해 이를 혐오표현이 포함됬을 확률을 구합니다. 이를 그대로 분노 점수로 활용합니다.
